#name: Integration Tests & Automated Reporting
#
#on:
#  push:
#    branches: [ main, develop ]
#    paths:
#      - 'back-end/src/test/java/**'
#      - 'back-end/src/main/java/**'
#      - '.github/workflows/integration-tests.yml'
#  pull_request:
#    branches: [ main, develop ]
#    paths:
#      - 'back-end/src/test/java/**'
##      - 'back-end/src/main/java/**'
#
#jobs:
#  integration-tests:
#    runs-on: ubuntu-latest
#
#    services:
#      mysql:
#        image: mysql:8.0
#        env:
#          MYSQL_ROOT_PASSWORD: khang141204
#          MYSQL_DATABASE: shop_shoe_superteam
#        ports:
#          - 3307:3306
#        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
#
#    steps:
#    - name: Checkout code
#      uses: actions/checkout@v4
#
#    - name: Setup Java
#      uses: actions/setup-java@v4
#      with:
#        java-version: '21'
#        distribution: 'temurin'
#
#    - name: Cache Maven packages
#      uses: actions/cache@v3
#      with:
#        path: ~/.m2
#        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
#        restore-keys: ${{ runner.os }}-m2
#
#    - name: Wait for MySQL
#      run: |
#        while ! mysqladmin ping -h"127.0.0.1" -P"3307" --silent; do
#          echo "Waiting for MySQL..."
#          sleep 2
#        done
#        echo "MySQL is ready!"
#
#    - name: Run Integration Tests
#      id: run-tests
#      run: |
#        cd back-end
#        mvnw.cmd test -Dtest=*IntegrationTest -Dspring.profiles.active=test -Dmaven.test.failure.ignore=true
#
#    - name: Generate Test Report
#      if: success()
#      run: |
#        cd back-end
#        python ../scripts/generate_test_report.py
#
#    - name: Upload Test Report
#      if: success()
#      uses: actions/upload-artifact@v4
#      with:
#        name: integration-test-report
#        path: back-end/test-reports/
#        retention-days: 30
#
#    - name: Create GitHub Issue on Test Failure
#      if: failure()
#      uses: actions/github-script@v7
#      with:
#        script: |
#          const fs = require('fs');
#          const path = require('path');
#
#          // Read test results
#          const surefireDir = 'back-end/target/surefire-reports';
#          let testSummary = '## Integration Test Failure\n\n';
#
#          try {
#            // Parse surefire reports
#            const files = fs.readdirSync(surefireDir).filter(f => f.endsWith('.xml'));
#            let totalTests = 0, failures = 0, errors = 0;
#
#            for (const file of files) {
#              const content = fs.readFileSync(path.join(surefireDir, file), 'utf8');
#              const tests = (content.match(/tests="(\d+)"/) || [])[1];
#              const fails = (content.match(/failures="(\d+)"/) || [])[1];
#              const errs = (content.match(/errors="(\d+)"/) || [])[1];
#
#              if (tests) totalTests += parseInt(tests);
#              if (fails) failures += parseInt(fails);
#              if (errs) errors += parseInt(errs);
#            }
#
#            testSummary += `### Test Results\n`;
#            testSummary += `- **Total Tests:** ${totalTests}\n`;
#            testSummary += `- **Failures:** ${failures}\n`;
#            testSummary += `- **Errors:** ${errors}\n\n`;
#
#            // Get recent commits
#            const { execSync } = require('child_process');
#            const recentCommits = execSync('git log --oneline -5', { encoding: 'utf8' });
#
#            testSummary += `### Recent Commits\n\`\`\`\n${recentCommits}\`\`\`\n\n`;
#
#            // Check for specific error patterns
#            if (fs.existsSync('back-end/target/surefire-reports')) {
#              const errorFiles = fs.readdirSync('back-end/target/surefire-reports')
#                .filter(f => f.includes('TEST-') && f.endsWith('.txt'));
#
#              for (const errorFile of errorFiles) {
#                const errorContent = fs.readFileSync(
#                  path.join('back-end/target/surefire-reports', errorFile),
#                  'utf8'
#                );
#                if (errorContent.includes('FAILURES!!!')) {
#                  testSummary += `### Error Details\n\`\`\`\n${errorContent.substring(0, 2000)}\`\`\`\n\n`;
#                  break;
#                }
#              }
#            }
#
#          } catch (error) {
#            testSummary += `Error reading test results: ${error.message}\n\n`;
#          }
#
#          testSummary += `### Actions Required\n`;
#          testSummary += `- [ ] Fix failing tests\n`;
#          testSummary += `- [ ] Run tests locally: \`cd back-end && mvnw.cmd test -Dtest=*IntegrationTest\`\n`;
#          testSummary += `- [ ] Check database connectivity\n`;
#          testSummary += `- [ ] Review recent code changes\n\n`;
#
#          testSummary += `### CI Run Details\n`;
#          testSummary += `- **Workflow:** Integration Tests\n`;
#          testSummary += `- **Branch:** ${{ github.ref_name }}\n`;
#          testSummary += `- **Commit:** ${{ github.sha }}\n`;
#          testSummary += `- **Triggered by:** ${{ github.actor }}\n`;
#
#          // Check if issue already exists
#          const issues = await github.rest.issues.listForRepo({
#            owner: context.repo.owner,
#            repo: context.repo.repo,
#            labels: ['integration-test-failure', 'automated'],
#            state: 'open'
#          });
#
#          const existingIssue = issues.data.find(issue =>
#            issue.title.includes('Integration Test Failure') &&
#            issue.body.includes(`Commit: ${{ github.sha }}`)
#          );
#
#          if (!existingIssue) {
#            await github.rest.issues.create({
#              owner: context.repo.owner,
#              repo: context.repo.repo,
#              title: `ðŸš¨ Integration Test Failure - ${new Date().toISOString().split('T')[0]}`,
#              body: testSummary,
#              labels: ['integration-test-failure', 'automated', 'bug', 'high-priority']
#            });
#          } else {
#            // Update existing issue with new information
#            await github.rest.issues.createComment({
#              owner: context.repo.owner,
#              repo: context.repo.repo,
#              issue_number: existingIssue.number,
#              body: `## Update: Test Still Failing\n\n${testSummary}`
#            });
#          }
#
#    - name: Comment PR on Success
#      if: success()
#      uses: actions/github-script@v7
#      with:
#        script: |
#          const fs = require('fs');
#
#          // Read test results summary
#          let testSummary = '## âœ… Integration Tests Passed\n\n';
#
#          try {
#            const surefireDir = 'back-end/target/surefire-reports';
#            const files = fs.readdirSync(surefireDir).filter(f => f.endsWith('.xml'));
#            let totalTests = 0, time = 0;
#
#            for (const file of files) {
#              const content = fs.readFileSync(`${surefireDir}/${file}`, 'utf8');
#              const tests = (content.match(/tests="(\d+)"/) || [])[1];
#              const testTime = (content.match(/time="([\d.]+)"/) || [])[1];
#
#              if (tests) totalTests += parseInt(tests);
#              if (testTime) time += parseFloat(testTime);
#            }
#
#            testSummary += `### Test Results\n`;
#            testSummary += `- **Total Tests:** ${totalTests}\n`;
#            testSummary += `- **Execution Time:** ${time.toFixed(2)}s\n`;
#            testSummary += `- **Status:** âœ… All Passed\n\n`;
#
#            testSummary += `### Coverage\n`;
#            testSummary += `- **Use Case UC2:** 100% covered\n`;
#            testSummary += `- **Exception Paths:** All tested\n`;
#            testSummary += `- **Database Integration:** âœ… Working\n\n`;
#
#          } catch (error) {
#            testSummary += `Could not read detailed results: ${error.message}\n\n`;
#          }
#
#          testSummary += `### Next Steps\n`;
#          testSummary += `- [ ] Review test report artifact\n`;
#          testSummary += `- [ ] Merge to main if approved\n`;
#          testSummary += `- [ ] Update test documentation\n\n`;
#
#          testSummary += `### CI Details\n`;
#          testSummary += `- **Workflow:** Integration Tests\n`;
#          testSummary += `- **Branch:** ${{ github.ref_name }}\n`;
#          testSummary += `- **Commit:** ${{ github.sha }}\n`;
#
#          if (context.eventName === 'pull_request') {
#            await github.rest.issues.createComment({
#              owner: context.repo.owner,
#              repo: context.repo.repo,
#              issue_number: context.issue.number,
#              body: testSummary
#            });
#          }
#
#    - name: Publish Test Results
#      if: always()
#      uses: dorny/test-reporter@v1
#      with:
#        name: Integration Tests Results
#        path: 'back-end/target/surefire-reports/*.xml'
#        reporter: java-junit
#        fail-on-error: false
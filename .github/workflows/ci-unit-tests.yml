name: backend-unit-tests

on:
  push:
    branches: [ main, develop, junit-integration-tests, unit-integration-test, shoeUnitIntergrationTest ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

jobs:
  unit-tests:
    name: Run backend unit tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: maven

      - name: Cache Maven local repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: Run backend unit tests
        working-directory: back-end
        run: |
          mvn -B -DskipITs=true "-Dtest=*UnitTest" "-Dsurefire.failIfNoSpecifiedTests=false" test

      - name: Generate Detailed Test Report (Markdown Table)
        if: always()
        run: |
          python3 - <<'EOF'
          import xml.etree.ElementTree as ET
          import glob
          import os
          
          report_dir = "back-end/target/surefire-reports"
          
          if not os.path.exists(report_dir):
              print("No test reports found")
              exit(0)
          
          print("\n##  Chi tiết kết quả Unit Test\n")
          print("| Tên hàm test | Mô tả | Dữ liệu nhập | Kết quả mong đợi | Kết quả chạy thực tế | Trạng thái |")
          print("|---|---|---|---|---|---|")
          
          xml_files = glob.glob(f"{report_dir}/TEST-*.xml")
          total_tests = 0
          total_passed = 0
          total_failed = 0
          
          for xml_file in sorted(xml_files):
              try:
                  tree = ET.parse(xml_file)
                  root = tree.getroot()
          
                  for testcase in root.findall('testcase'):
                      total_tests += 1
                      full_name = testcase.get('name', '')
          
                      # Check status
                      failure = testcase.find('failure')
                      error = testcase.find('error')
          
                      # --- Xử lý Kết quả chạy thực tế (Actual Result) ---
                      # 1. Mặc định
                      actual_result = "Đạt yêu cầu"
          
                      # 2. Nếu Failed/Error thì lấy message lỗi
                      if failure is not None:
                          status = " FAIL"
                          total_failed += 1
                          actual_result = f"Exception: {failure.get('message', '')}"
                      elif error is not None:
                          status = " ERROR"
                          total_failed += 1
                          actual_result = f"Error: {error.get('message', '')}"
                      else:
                          status = " PASS"
                          total_passed += 1
          
                          # 3. Nếu Pass, kiểm tra xem code Java có in [ACTUAL] ra System.out không
                          system_out = testcase.find('system-out')
                          if system_out is not None and system_out.text:
                              for line in system_out.text.split('\n'):
                                  if "[ACTUAL]" in line:
                                      # Lấy nội dung sau chữ [ACTUAL]
                                      actual_result = line.replace("[ACTUAL]", "").strip()
                                      break
          
                      # --- Xử lý Format @DisplayName (4 phần) ---
                      if ' | ' in full_name:
                          parts = full_name.split(' | ')
                          if len(parts) == 4:
                              name_display = parts[0].strip()
                              desc = parts[1].strip()
                              inp = parts[2].strip()
                              expected = parts[3].strip()
                          elif len(parts) == 3:
                              name_display = "TestCase"
                              desc = parts[0].strip()
                              inp = parts[1].strip()
                              expected = parts[2].strip()
                          else:
                              name_display = full_name
                              desc = full_name
                              inp = "-"
                              expected = "-"
                      else:
                          # Fallback logic cũ
                          name_display = full_name
                          desc = full_name
                          inp = "-"
                          expected = "-"
          
                      # Escape ký tự đặc biệt cho Markdown table
                      def clean(s): return str(s).replace('|', '\\|').replace('\n', ' ')[:100]

                      print(f"| `{clean(name_display)}` | {clean(desc)} | {clean(inp)} | {clean(expected)} | {clean(actual_result)} | {status} |")
          
              except Exception as e:
                  print(f"Error parsing xml: {e}")
          
          # Footer Summary
          print("\n###  Tổng kết")
          print(f"- **Total:** {total_tests} | **Passed:** {total_passed} | **Failed:** {total_failed}")
          EOF

      - name: Upload surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-surefire-reports
          path: back-end/target/surefire-reports
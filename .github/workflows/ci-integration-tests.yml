name: CI - Cart Management Integration Tests

on:
  push:
    branches: [ junit-integration-tests ]
    paths:
      - 'back-end/src/**'
      - 'back-end/pom.xml'
      - '.github/workflows/ci-integration-tests.yml'
  pull_request:
    branches: [ junit-integration-tests ]
    paths:
      - 'back-end/src/**'
      - 'back-end/pom.xml'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  cart-integration-tests:
    name: Cart Management Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: khang141204
          MYSQL_DATABASE: shop_shoe_superteam
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: â˜• Setup JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: ğŸ—„ï¸ Wait for MySQL to be Ready
      run: |
        echo "â³ Waiting for MySQL to be fully ready..."
        for i in {1..30}; do
          if mysqladmin ping -h"127.0.0.1" -P"3306" -uroot -pkhang141204 --silent; then
            echo "âœ… MySQL is ready!"
            break
          fi
          echo "Attempt $i/30: MySQL not ready yet..."
          sleep 2
        done
        
        # Verify database exists
        mysql -h127.0.0.1 -P3306 -uroot -pkhang141204 -e "SHOW DATABASES;" | grep shop_shoe_superteam || exit 1
        echo "âœ… Database shop_shoe_superteam confirmed!"

    - name: ğŸ”§ Configure Test Database
      run: |
        cd back-end
        # Create application-test.yml that matches local configuration
        mkdir -p src/test/resources
        cat > src/test/resources/application.yml << 'EOF'
        spring:
          datasource:
            url: jdbc:mysql://localhost:3306/shop_shoe_superteam?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
            username: root
            password: khang141204
            driver-class-name: com.mysql.cj.jdbc.Driver
          jpa:
            hibernate:
              ddl-auto: update
            show-sql: false
            properties:
              hibernate:
                format_sql: true
        EOF
        echo " Created application.yml for test environment"

    - name: Run CartManagementIntegrationTest
      id: run-tests
      run: |
        cd back-end
        echo " Running CartManagementIntegrationTest..."
        mvn -B clean test -Dtest=CartManagementIntegrationTest 2>&1 | tee test-output.log
        TEST_EXIT_CODE=${PIPESTATUS[0]}
        echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
        if [ $TEST_EXIT_CODE -ne 0 ]; then
          exit $TEST_EXIT_CODE
        fi

    - name:  Generate Test Summary
      if: always()
      run: |
        cd back-end
        echo "##  Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d target/surefire-reports ]; then
          TOTAL=$(find target/surefire-reports -name "TEST-*.xml" | wc -l)
          echo "- **Total Test Files:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          
          # Parse test results if files exist
          if [ $TOTAL -gt 0 ]; then
            echo "- **Test Class:** CartManagementIntegrationTest" >> $GITHUB_STEP_SUMMARY
            echo "- **Expected Tests:** 4" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Test Methods:" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… testSuccessfulCartManagementAndCheckout" >> $GITHUB_STEP_SUMMARY
            echo "2. âœ… testAddOutOfStockProduct" >> $GITHUB_STEP_SUMMARY
            echo "3. âœ… testUpdateQuantityExceedingStock" >> $GITHUB_STEP_SUMMARY
            echo "4. âœ… testApplyInvalidDiscountCode" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo " No test reports found in target/surefire-reports" >> $GITHUB_STEP_SUMMARY
        fi

    - name:  Upload Test Reports (XML + TXT)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cart-test-reports-${{ github.run_number }}
        path: |
          back-end/target/surefire-reports/*.xml
          back-end/target/surefire-reports/*.txt
          back-end/test-output.log
        retention-days: 30
        if-no-files-found: warn

    - name:  Publish Test Dashboard
      if: success()
      uses: dorny/test-reporter@v1
      with:
        name:  Cart Integration Test Results
        path: back-end/target/surefire-reports/TEST-*.xml
        reporter: java-junit
        fail-on-error: false
        max-annotations: 50

    - name:  Create Detailed Issue on Test Failure
      if: failure() && steps.run-tests.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Read test output log if available
          let testOutput = 'Test output not available';
          const logPath = 'back-end/test-output.log';
          if (fs.existsSync(logPath)) {
            const fullLog = fs.readFileSync(logPath, 'utf8');
            // Extract last 100 lines of errors
            const lines = fullLog.split('\n');
            testOutput = lines.slice(-100).join('\n');
          }

          const issueTitle = ` CI FAILED: CartManagementIntegrationTest - Run #${context.runNumber} (${context.ref.replace('refs/heads/', '')})`;

          const issueBody = `
          ##  Cart Management Integration Test Failure

          ###  CI Execution Details
          | Property | Value |
          |----------|-------|
          | **Workflow** | ${context.workflow} |
          | **Run Number** | #${context.runNumber} |
          | **Branch** | ${context.ref.replace('refs/heads/', '')} |
          | **Commit** | \`${context.sha.substring(0, 7)}\` |
          | **Triggered By** | @${context.actor} |
          | **Run URL** | [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) |

          ###  Test Information
          - **Test Class:** \`CartManagementIntegrationTest\`
          - **Location:** \`back-end/src/test/java/com/example/shoeshop/auth/CartManagementIntegrationTest.java\`
          - **Status:**  **FAILED**
          - **Use Case:** UC2 - Quáº£n lÃ½ vÃ  Cáº­p nháº­t Giá» hÃ ng

          ###  Expected Test Methods (4 total)
          - [ ] \`testSuccessfulCartManagementAndCheckout\` - Full cart workflow
          - [ ] \`testAddOutOfStockProduct\` - Stock validation
          - [ ] \`testUpdateQuantityExceedingStock\` - Quantity limits
          - [ ] \`testApplyInvalidDiscountCode\` - Discount validation

          ###  Test Reports & Artifacts
          - **Artifact Name:** \`cart-test-reports-${context.runNumber}\`
          - **Download:** [Click here](${context.payload.repository.html_url}/actions/runs/${context.runId})
          - **Contains:** JUnit XML reports, text reports, and full test output log

          ###  Recent Test Output
          <details>
          <summary>Click to view last 100 lines of test execution</summary>

          \`\`\`
          ${testOutput}
          \`\`\`
          </details>

          ### ï¸ Troubleshooting Steps
          1. **Check the logs:**
             \`\`\`bash
             # View the Actions run logs at:
             ${context.payload.repository.html_url}/actions/runs/${context.runId}
             \`\`\`

          2. **Download test reports:**
             - Go to Actions run â†’ Artifacts section
             - Download \`cart-test-reports-${context.runNumber}\`
             - Review XML/TXT files for detailed errors

          3. **Run tests locally:**
             \`\`\`bash
             cd back-end
             mvn clean test -Dtest=CartManagementIntegrationTest
             \`\`\`

          4. **Check database connection:**
             - Verify MySQL is running locally
             - Check \`application-test.yml\` configuration
             - Ensure test database schema is up-to-date

          5. **Review test dependencies:**
             - Check all @Autowired repositories are available
             - Verify test data setup in \`@BeforeEach setUp()\`
             - Check foreign key constraints are handled

          ###  Files to Review
          - \`back-end/src/test/java/com/example/shoeshop/auth/CartManagementIntegrationTest.java\`
          - \`back-end/src/test/resources/application-test.yml\`
          - \`back-end/pom.xml\` (check test dependencies)
          - Controller endpoints: \`CartController.java\`, \`OrderController.java\`

          ###  Common Issues & Solutions
          | Issue | Solution |
          |-------|----------|
          | Foreign key constraint violations | Check cleanup order in \`setUp()\` method |
          | 404 endpoint errors | Verify @RequestMapping paths match test URLs |
          | Database connection timeout | Ensure MySQL service is healthy in CI |
          | Test data conflicts | Use unique test data (timestamps in SKU) |

          ### ğŸ‘¥ Assignees
          Please assign this to the QA team or developer who last modified the test file.

          ---
           **Auto-generated by GitHub Actions CI**
           **Created:** ${new Date().toISOString()}
          ğŸ· **Labels:** ci, integration-test, bug, cart-management, automated
          `;

          // Check for existing open issues to avoid duplicates
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'ci,integration-test',
            state: 'open'
          });

          const duplicateIssue = existingIssues.data.find(issue =>
            issue.title.includes(`Run #${context.runNumber}`) &&
            issue.title.includes('CartManagementIntegrationTest')
          );

          if (!duplicateIssue) {
            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['ci', 'integration-test', 'bug', 'cart-management', 'automated', 'test-failure']
            });
            
            console.log(` Created issue #${newIssue.data.number}: ${issueTitle}`);
          } else {
            console.log(`âš  Duplicate issue already exists: #${duplicateIssue.number}`);
            
            // Add a comment to existing issue instead
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: duplicateIssue.number,
              body: ` **Another failure occurred in Run #${context.runNumber}**\n\n[View latest run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });
          }

    - name:  Comment on PR (Success)
      if: success() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `
          ##  Cart Integration Tests Passed!

          ###  Test Execution Summary
          | Metric | Value |
          |--------|-------|
          | **Status** |  **ALL TESTS PASSED** |
          | **Test Class** | CartManagementIntegrationTest |
          | **Total Tests** | 4 |
          | **Success Rate** | 100% |
          | **Coverage** | UC2 Cart Management (Complete) |
          | **Database** | MySQL 8.0  |
          | **Run** | [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId}) |

          ###  Test Details
          | # | Test Method | Status | Purpose |
          |---|-------------|--------|---------|
          | 1 | testSuccessfulCartManagementAndCheckout |  PASS | Complete cart workflow with discount |
          | 2 | testAddOutOfStockProduct |  PASS | Stock availability validation |
          | 3 | testUpdateQuantityExceedingStock |  PASS | Quantity limit enforcement |
          | 4 | testApplyInvalidDiscountCode |  PASS | Discount code validation |

          ###  Test Reports Available
          **Download Artifacts:** [cart-test-reports-${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
          - JUnit XML reports
          - Detailed text reports
          - Full test execution log

          ###  What This Means
          -  All cart management features working correctly
          -  Database integration successful
          -  Foreign key constraints properly handled
          -  API endpoints responding as expected
          -  Error handling validated

          ###  Ready for Merge
          All integration tests passed! The cart management functionality is stable and ready for deployment.

          ---
           *CI Bot - Cart Integration Tests*
           *${new Date().toISOString()}*
          `;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });

    - name:  Comment on PR (Failure)
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `
          ##  Cart Integration Tests Failed

          ###  Test Execution Summary
          | Metric | Value |
          |--------|-------|
          | **Status** |  **TESTS FAILED** |
          | **Test Class** | CartManagementIntegrationTest |
          | **Run** | [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId}) |

          ###  Action Required
          -  An issue has been automatically created with detailed failure information
          -  Download test reports from [Artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId})
          -  Review the [Actions logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details

          ###  Quick Debug
          \`\`\`bash
          cd back-end
          mvn clean test -Dtest=CartManagementIntegrationTest
          \`\`\`

           **Please fix the failing tests before merging this PR.**

          ---
           *CI Bot - Cart Integration Tests*
          `;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });

# ========================================================================================
# ğŸ“š WORKFLOW DOCUMENTATION & CUSTOMIZATION GUIDE
# ========================================================================================
#
# ğŸ¯ WORKFLOW OVERVIEW:
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# This CI workflow automatically tests the Cart Management Integration Test suite
# for the shoe shop application's cart functionality (UC2 - Cart Management).
#
# ğŸ“‹ EXECUTION FLOW:
# 1. âœ… Trigger: Push/PR to main, develop, or junit-integration-tests branches
# 2. ğŸ³ Setup: Ubuntu + JDK 21 + MySQL 8.0 Docker service
# 3. ğŸ§ª Test: Run CartManagementIntegrationTest (4 test methods)
# 4. ğŸ“Š Report: Always upload JUnit XML/TXT reports as artifacts
# 5. âœ… Success: Publish interactive test dashboard + comment on PR
# 6. âŒ Failure: Auto-create GitHub issue with detailed error info + comment on PR
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# ğŸ”§ CUSTOMIZATION OPTIONS:
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# 1ï¸âƒ£ CHANGE TRIGGER BRANCHES:
#    Line 4-6: branches: [ main, develop, your-branch ]
#
# 2ï¸âƒ£ CHANGE TRIGGER PATHS (run only when specific files change):
#    Line 7-10: Add/remove paths to monitor
#
# 3ï¸âƒ£ CHANGE TEST COMMAND:
#    Line 97: Current: mvn -B clean test -Dtest=CartManagementIntegrationTest
#    Options:
#      - Run all tests: mvn -B test
#      - Run specific package: mvn -B test -Dtest=com.example.shoeshop.auth.*
#      - Run with coverage: mvn -B verify jacoco:report
#
# 4ï¸âƒ£ CHANGE MYSQL DATABASE NAME:
#    Line 24: MYSQL_DATABASE: your_database_name
#    Line 62: Update application-test.yml URL accordingly
#
# 5ï¸âƒ£ CHANGE MYSQL PASSWORD:
#    Line 23: MYSQL_ROOT_PASSWORD: your_password
#    Line 62: Update application-test.yml password
#
# 6ï¸âƒ£ CHANGE JDK VERSION:
#    Line 45: java-version: '17' or '11'
#
# 7ï¸âƒ£ CHANGE ARTIFACT RETENTION:
#    Line 132: retention-days: 7 (shorter) or 90 (longer)
#
# 8ï¸âƒ£ CHANGE ISSUE LABELS:
#    Line 278: labels: ['your-label1', 'your-label2']
#
# 9ï¸âƒ£ ADD MORE TEST CLASSES:
#    Line 97: -Dtest=CartManagementIntegrationTest,OrderIntegrationTest
#
# ğŸ”Ÿ CHANGE TIMEOUT:
#    Line 19: timeout-minutes: 30 (for slower tests)
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# ğŸ“Š TEST REPORT LOCATIONS:
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# - XML Reports: back-end/target/surefire-reports/*.xml
# - Text Reports: back-end/target/surefire-reports/*.txt
# - Full Log: back-end/test-output.log
# - Download from: Actions â†’ Run â†’ Artifacts section
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# ğŸš¨ TROUBLESHOOTING COMMON ISSUES:
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# âŒ MySQL connection failed:
#    â†’ Check MYSQL_ROOT_PASSWORD matches in both service and test config
#    â†’ Verify port 3306 is not already in use
#    â†’ Increase health check retries (Line 31)
#
# âŒ Tests timeout:
#    â†’ Increase job timeout (Line 19)
#    â†’ Check MySQL health check is passing
#
# âŒ Artifacts not found:
#    â†’ Verify paths in upload-artifact step (Line 129-131)
#    â†’ Check if tests actually ran and generated reports
#
# âŒ Issue creation fails:
#    â†’ Verify GITHUB_TOKEN has issues:write permission
#    â†’ Check repository settings â†’ Actions â†’ General â†’ Workflow permissions
#
# âŒ dorny/test-reporter fails:
#    â†’ Ensure at least one TEST-*.xml file exists
#    â†’ Check XML file is valid JUnit format
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# ğŸ“ ADDITIONAL ENHANCEMENTS (Optional):
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# ğŸ’¬ Add Slack Notifications:
#    - uses: slackapi/slack-github-action@v1
#    - Notify team on test failures
#
# ğŸ“Š Add Code Coverage:
#    - Use JaCoCo plugin: mvn verify jacoco:report
#    - Upload coverage: uses: codecov/codecov-action@v3
#
# ğŸ” Add Secret Scanning:
#    - uses: trufflesecurity/trufflehog@main
#
# ğŸ“ˆ Add Performance Testing:
#    - Measure test execution time
#    - Track over time to detect slowdowns
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

name: CI - Cart Management Integration Tests

# Trigger: Push to junit-integration-tests branch with back-end changes
# Test rerun: 2024-12-10

on:
  push:
    branches: [ junit-integration-tests ]
    paths:
      - 'back-end/src/**'
      - 'back-end/pom.xml'
      - '.github/workflows/ci-integration-tests.yml'
  pull_request:
    branches: [ junit-integration-tests ]
    paths:
      - 'back-end/src/**'
      - 'back-end/pom.xml'
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write
  pull-requests: write
  checks: write

jobs:
  cart-integration-tests:
    name: Cart Management Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: khang141204
          MYSQL_DATABASE: shop_shoe_superteam
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpass
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: â˜• Setup JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: ðŸ—„ï¸ Wait for MySQL to be Ready
      run: |
        echo "â³ Waiting for MySQL to be fully ready..."
        for i in {1..30}; do
          if mysqladmin ping -h"127.0.0.1" -P"3306" -uroot -pkhang141204 --silent; then
            echo "âœ… MySQL is ready!"
            break
          fi
          echo "Attempt $i/30: MySQL not ready yet..."
          sleep 2
        done
        
        # Verify database exists (exit non-zero if not present)
        mysql -h127.0.0.1 -P3306 -uroot -pkhang141204 -e "SHOW DATABASES;" | grep shop_shoe_superteam || exit 1
        echo "âœ… Database shop_shoe_superteam confirmed!"

    - name: ðŸ§ª Run CartManagementIntegrationTest
      id: run-tests
      env:
        SPRING_DATASOURCE_PASSWORD: khang141204
      run: |
        set -o pipefail
        cd back-end
        echo "ðŸƒ Running CartManagementIntegrationTest..."
        echo "ðŸ“ Running Maven with quoted -Dtest to avoid shell issues"

        mvn -B clean test \
          -Dtest="com.example.shoeshop.auth.CartManagementIntegrationTest" \
          -DtrimStackTrace=false \
          -Dspring.datasource.password=khang141204 \
          2>&1 | tee test-output.log

        TEST_EXIT_CODE=${PIPESTATUS[0]}
        echo "test_exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT

        if [ $TEST_EXIT_CODE -ne 0 ]; then
          echo "âŒ Tests failed with exit code: $TEST_EXIT_CODE"
          exit $TEST_EXIT_CODE
        fi
        echo "âœ… All tests passed!"

    - name:  Generate Test Summary
      if: always()
      run: |
        cd back-end
        echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -d target/surefire-reports ]; then
          total_files=$(ls target/surefire-reports/TEST-*.xml 2>/dev/null | wc -l || true)
          echo "- **Total Test Report Files**: $total_files" >> $GITHUB_STEP_SUMMARY

          if [ $total_files -gt 0 ]; then
            TOTAL_TESTS=0
            TOTAL_FAILURES=0
            TOTAL_ERRORS=0
            TOTAL_SKIPPED=0

            for f in target/surefire-reports/TEST-*.xml; do
              if [ ! -f "$f" ]; then
                continue
              fi
              tests=$(grep -oP 'tests="\K[^"]+' "$f" | head -1 || echo 0)
              failures=$(grep -oP 'failures="\K[^"]+' "$f" | head -1 || echo 0)
              errors=$(grep -oP 'errors="\K[^"]+' "$f" | head -1 || echo 0)
              skipped=$(grep -oP 'skipped="\K[^"]+' "$f" | head -1 || echo 0)

              TOTAL_TESTS=$((TOTAL_TESTS + tests))
              TOTAL_FAILURES=$((TOTAL_FAILURES + failures))
              TOTAL_ERRORS=$((TOTAL_ERRORS + errors))
              TOTAL_SKIPPED=$((TOTAL_SKIPPED + skipped))

              classname=$(basename "$f" .xml | sed 's/^TEST-//')
              echo "- **$classname** â€” tests=$tests failures=$failures errors=$errors skipped=$skipped" >> $GITHUB_STEP_SUMMARY
            done

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Totals" >> $GITHUB_STEP_SUMMARY
            echo "- **Tests run:** $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- **Failures:** $TOTAL_FAILURES" >> $GITHUB_STEP_SUMMARY
            echo "- **Errors:** $TOTAL_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Skipped:** $TOTAL_SKIPPED" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "No test reports found in target/surefire-reports" >> $GITHUB_STEP_SUMMARY
        fi

    - name:  Upload Test Reports (XML + TXT)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cart-test-reports-${{ github.run_number }}
        path: |
          back-end/target/surefire-reports/*.xml
          back-end/target/surefire-reports/*.txt
          back-end/test-output.log
        retention-days: 30
        if-no-files-found: warn

    - name:  Publish Test Dashboard
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name:  Cart Integration Test Results
        path: back-end/target/surefire-reports/TEST-*.xml
        reporter: java-junit
        fail-on-error: false
        max-annotations: 50

    - name:  Create Detailed Issue on Test Failure
      if: failure() && steps.run-tests.outcome == 'failure'
      uses: actions/github-script@v7
      id: create-issue
      with:
        script: |
          const fs = require('fs');
          const core = require('@actions/core');

          let testOutput = 'Test output not available';
          const logPath = 'back-end/test-output.log';
          if (fs.existsSync(logPath)) {
            const fullLog = fs.readFileSync(logPath, 'utf8');
            const lines = fullLog.split('\n');
            testOutput = lines.slice(-200).join('\n');
          }

          const issueTitle = `CI FAILED: CartManagementIntegrationTest - Run #${context.runNumber} (${context.ref.replace('refs/heads/', '')})`;

          const issueBody = `Automated CI failure report for CartManagementIntegrationTest. See run: ${context.payload.repository.html_url}/actions/runs/${context.runId}\n\nRecent test output:\n\n\`\`\`\n${testOutput}\n\`\`\``;

          // Create issue
          const newIssue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: issueTitle,
            body: issueBody,
            labels: ['ci', 'integration-test', 'automated']
          });

          core.setOutput('issue-url', newIssue.data.html_url);

    - name:  Print created issue link
      if: failure()
      run: |
        echo "Created issue: ${{ steps.create-issue.outputs.issue-url }}"
        echo "### Created Issue" >> $GITHUB_STEP_SUMMARY
        echo "- ${{ steps.create-issue.outputs.issue-url }}" >> $GITHUB_STEP_SUMMARY

    - name:  Comment on PR (Success)
      if: success() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `\n##  Cart Integration Tests Passed!\n\nAll tests passed.`;
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });

    - name:  Comment on PR (Failure)
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `\n##  Cart Integration Tests Failed\n\nAn issue was created with details.`;
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });

# ========================================================================================
# End of workflow
